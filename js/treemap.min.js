/**!
 * Treemap
 * This component, using d3js API, draw an animated treemap
 *
 * @license 
 * @author Triad <flores.leonardo@gmail.com> (http://github.com/lflores)
 * @version 0.3.2
 **/
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.TreeMap=b()}):"object"==typeof exports?module.exports=b():a.TreeMap=b()}(this,function(){return"undefined"==typeof String.replaceParams&&(String.prototype.replaceParams=function(a){if("undefined"==typeof a)return this;"string"==typeof a&&(a=[a]);for(var b=this.replace(/^\s+|\s+$/g,""),c=0;c<a.length;c++)b=b.replace("{"+c+"}",a[c]).replace("{"+c+"}",a[c]);return b}),String.prototype.splitMultiple=function(a){"undefined"==typeof a&&(a="\n-");var b=a.split(""),c=this.split(b[0]);if(b.splice(0,1),0===b.length)return c.map(function(a){return a.trim()});for(var d=[],e=0;e<c.length;e++){var f=c[e].splitMultiple(b.join(""));f.length>1?d=d.concat(f):d.push(f[0])}return d},CustomTooltip=function(a,b){function c(b,c){var d=b.splitMultiple();$("#"+a).html(d.join("<br>")),$("#"+a).show(),e(c)}function d(){$("#"+a).hide()}function e(b){var c="#"+a,d=20,e=10,f=$(c).width(),g=$(c).height(),h=$(window).scrollTop(),i=$(window).scrollLeft(),j=document.all?b.clientX+i:b.pageX,k=document.all?b.clientY+h:b.pageY,l=j-i+2*d+f>$(window).width()?j-f-2*d:j+d;i+d>l&&(l=i+d);var m=k-h+2*e+g>$(window).height()?k-g-2*e:k+e;h+e>m&&(m=k+e),$(c).css("top",m+"px").css("left",l+"px")}return 0===$("#"+a).length&&$("body").append('<div class="treemap-tooltip" id="'+a+'"></div>'),b&&$("#"+a).css("width",b),d(),{showTooltip:c,hideTooltip:d,updatePosition:e}},TreeMap=function(a){this.margin={top:3,right:3,bottom:3,left:3};var b={sticky:!1,height:100,width:100,points:[0,15,20,40,100],colors:["#d84b2a","#beccae","#7aa25c","#7aa25c"],id:"treemap",colorById:"perc",sizeById:"size",showChild:!1,labelFactor:.8,data:{label:{template:"{description}",formatter:d3.format(",.2f")},tooltip:"<b>{name} - {description}</b><br><b>GP %:</b>{gp_brl} <br><b>GTN %:</b> {gtn_brl}<br><b>NS:</b> {ns_brl}",onclick:function(a,b){}}};this._config=$.extend(!0,b,a),this.tooltip=CustomTooltip("treemap_tooltip",240),this.create()},TreeMap.prototype.create=function(){var a=this;this.colorScale=d3.scale.linear().domain(this._config.points).range(this._config.colors),this.fontColorScale=d3.scale.linear().domain(this._config.points).range(this._config.colors.reverse()),this.container=d3.select("#"+this._config.id),this.container.style("overflow","hidden"),this.svg=this.container.append("svg").attr("class","treemap-container").attr("width",this._config.width).attr("height",this._config.height),this.treemap=d3.layout.treemap().size([this._config.width,this._config.height]).sticky(this._config.sticky).padding([this.margin.left,this.margin.right,this.margin.bottom,this.margin.top]).sort(function(b,c){return Number(b[a._config.sizeById])-Number(c[a._config.sizeById])}).value(function(b){return b.hasOwnProperty(a._config.sizeById)?Number(b[a._config.sizeById]):null}),this._selected=[]},TreeMap.prototype.data=function(a){this._data=a,this.nodes&&this.nodes.classed("selected",!1),this._selected=[],this.refresh()},TreeMap.prototype.colorBy=function(a,b){return b._config.data&&"function"==typeof b._config.data.color?b._config.data.color.call(b,a):b.colorScale(Number(a[b._config.colorById]))},TreeMap.prototype.colors=function(a){this._config.colors=a;this.colorScale.range(this._config.colors),this.refresh()},TreeMap.prototype.points=function(a){this._config.points=a;this.colorScale.domain(this._config.points),this.refresh()},TreeMap.prototype._label_by=function(a,b){var c="";return"function"==typeof b._config.data.label?(c=b._config.data.label.call(a,b),b._data_replace(a,_text)):"object"==typeof b._config.data.label&&"function"==typeof b._config.data.label.template?(c=b._config.data.label.template.call(b,[a]),b._data_replace(a,c,b._config.data.label.formatter)):"object"==typeof b._config.data.label&&b._config.data.label.template?(c=b._config.data.label.template,b._data_replace(a,c,b._config.data.label.formatter)):c},TreeMap.prototype._data_replace=function(a,b,c){b=b?b.slice(0):this._config.template,"undefined"==typeof c&&(c=d3.format(",.2f"));var d=b.match(/{(\w+)}/g);return d&&$.each(d,function(d,e){var f=/{(\w+)}/g.exec(e),g="";a.hasOwnProperty(f[1])&&"id"!=f[1]&&"name"!=f[1]&&"description"!=f[1]?g=isNaN(Number(a[f[1]]))?a[f[1]]:c(a[f[1]],f[1]):a.hasOwnProperty(f[1])&&(g=isNaN(Number(a[f[1]]))?a[f[1]]:""+Number(a[f[1]])),b=b.replace(e,g)}),b},TreeMap.prototype.colorById=function(a){this._config.colorById=a,this.refresh()},TreeMap.prototype.sizeById=function(a){this._config.sizeById=a,this.refresh()},TreeMap.prototype.refresh=function(){var a=this;this.rectangles=this.svg.datum(this._data).selectAll("g").data(this.treemap.nodes),this.rectangles.enter().append("g").on("mouseover",function(b,c){return a.show_details(b,c,a)}).on("mouseout",function(b,c){return a.hide_details(b,c,a)}).on("click",function(b,c){a.hide_details(b,c,a),d3.select(this).selectAll(".node").classed("selected",function(a,b){return!d3.select(this).classed("selected")}),d3.select(this).selectAll(".label").classed("selected",function(a,b){return!d3.select(this).classed("selected")}),a._config.data.onclick.call(a,b,this,c),a._toggle_selected(b)}).on("mouseenter",function(b,c){var d=a.colorBy(b,a);d3.select(this).selectAll(".node").style("fill",d3.rgb(d).brighter())}).on("mouseleave",function(b,c){d3.select(this).select(".node").style("fill",d3.rgb(a.colorBy(b,a)))}).append("rect").attr("class",function(b){return a.isSelected(b)?"node level-"+b.depth+" selected":"node level-"+b.depth}).call(a._position).style("fill",function(b){return a.colorBy(b,a)}).select(function(){return this.parentNode}).append("text").attr("class",function(a){return"label level-"+a.depth}).call(this._draw_text,this).call(this._text_position,this),this.rects=this.svg.selectAll(".node").data(this.treemap.nodes),this.texts=this.svg.selectAll(".label").data(this.treemap.nodes),this.rects.transition().attr("class",function(b){return a.isSelected(b)?"node level-"+b.depth+" selected":"node level-"+b.depth}).call(this._position,this).style("fill-opacity",1).style("fill",function(b){return a.colorBy(b,a)}),this.texts.attr("class",function(a){return"label level-"+a.depth}).call(this._draw_text,this).call(this._text_position,this),this.rects.exit().remove(),this.texts.exit().remove(),this.rectangles.exit().remove()},TreeMap.prototype._position=function(){this.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.dx<0?0:a.dx}).attr("height",function(a){return a.dy<0?0:a.dy})},TreeMap.prototype._toggle_selected=function(a){this._selected.indexOf(a)>-1?this._selected.splice(this._selected.indexOf(a),1):this._selected.push(a)},TreeMap.prototype.isSelected=function(a){return this._selected.indexOf(a)>-1},TreeMap.prototype._zoomIn=function(a){var b=this;b.svg.selectAll(".node").filter(function(b){return b.code!=a.code}).transition().duration(500).style("opacity",0).style("width",0).style("height",0).attr("transform","translate(-10,-10)"),b.scaleX.range(0,a.dx),b.scaleY.range(0,a.dy),b.node=b.svg.data([a]).selectAll(".node").classed("zoomed",function(b){return b.code==a.code}).style("left",function(c){return c.code!=a.code?b.scaleX(c.x)+"px":"0px"}).style("top",function(c){return c.code!=a.code?b.scaleY(c.y)+"px":"0px"}).style("width",function(c){return c.code!=a.code?"0px":b._config.width+"px"}).style("height",function(c){return c.code!=a.code?"0px":b._config.height+"px"}).style("background",function(b){return b.code!=a.code?"":"white"})},TreeMap.prototype._draw_text=function(a,b){a.each(function(a){d3.select(this).text(null);var c=b._label_by(a,b),d=d3.select(this),e=c.split(/\n+/).reverse(),f=[],g=1.1,h=(d.attr("x"),d.attr("y"));a.dy-4,d.data(0);f=e.pop();do{tspan=d.append("tspan").attr("x",0).attr("y",h).attr("dy",g+"em").text(f);for(var i=0;tspan.node().getComputedTextLength()>a.dx&&i++<5;)c=tspan.text(),_splited=c.split("-"),1===_splited.length&&(_splited=c.split(" ")),tspan.text(_splited[0].trim()),_splited.length>1&&(tspan=d.append("tspan").attr("x",0).attr("y",h).attr("dy",g+"em").text(_splited[1].trim()));f=e.pop()}while(f)})},TreeMap.prototype._text_position=function(a,b){d3.select(this);this.style("visibility",function(a){var c=this.getBBox();return b._config.data.label&&b._config.data.label.hasOwnProperty("autofit")&&b._config.data.label.autofit?"visible":0!==c.width&&0!==c.height&&c.width<a.dx&&c.height<a.dy?"visible":"hidden"}).transition().attr("transform",function(a){var c=this.getBBox();if(a.cx=a.x+a.dx/2,a.cy=a.y+a.dy/2,b._config.data.label&&b._config.data.label.hasOwnProperty("autofit")&&b._config.data.label.autofit){var d=a.dx/c.width;d=0===a.dx||0===c.width?1:d;var e=a.x+c.width*d/2,f=a.cy-c.height*d/2,g="translate({0},{1}),scale({2},{2})";return g.replaceParams([e,f,.8*d])}var h=a.x+a.dx/2-c.width/2+c.width/2,i=a.y+(a.dy-c.height)/2;return"translate("+h+","+i+")"})},TreeMap.prototype.update_details=function(a,b,c){return this.tooltip.updatePosition(c)},TreeMap.prototype.show_details=function(a,b,c){var d="";if("string"==typeof c._config.data.tooltip)d=c._data_replace(a,c._config.data.tooltip);else if("function"==typeof c._config.data.tooltip)d=c._config.data.tooltip.call(c,a),d=c._data_replace(a,d);else if("object"==typeof c._config.data.tooltip&&"function"==typeof c._config.data.tooltip.template){var e=c._config.data.tooltip.template.call(c,a);d=c._data_replace(a,e,c._config.data.tooltip.formatter)}else"object"==typeof c._config.data.tooltip&&"string"==typeof c._config.data.tooltip.template&&(d=c._data_replace(a,c._config.data.tooltip.template,c._config.data.tooltip.formatter));return this.tooltip.showTooltip(d,d3.event)},TreeMap.prototype.hide_details=function(a,b,c){return this.tooltip.hideTooltip()},TreeMap.prototype.config=function(a){return void 0===a?a:(this._config=$.extend(!0,this._config,a),d3.select("#"+this._config.id).transition().style("width",this._config.width).style("height",this._config.height),this.treemap.size([this._config.width,this._config.height]),this.colorScale.domain(this._config.points),this.colorScale.range(this._config.colors),void d3.select("#"+this._config.id).selectAll("svg").transition().style("width",this._config.width+"px").style("height",this._config.height+"px"))},TreeMap.prototype.resize=function(){this.config({width:parseInt(this.container.style("width")),height:parseInt(this.container.style("height"))});this._data&&this.refresh()},TreeMap});