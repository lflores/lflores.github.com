/**!
 * linear-gauge
 * Lightweight plugin to render simple linear gauge
 *
 * @license 
 * @author Leonardo Flores <flores.leonardo@gmail.com> (http://www.triadsoft.com.ar)
 * @version 0.7.5
 **/
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.lineargauge=b()}):"object"==typeof exports?module.exports=b():a.lineargauge=b()}(this,function(){var a=$.widget("custom.linearGauge",{options:{points:[0,25,50,75,100],colors:["#ff0000","#ffa300","#ffe100","#fffa00","#1f6f02"],orient:"bottom",margin:{left:5,right:5,top:5,bottom:10},height:40,thresholds:!0,minorTicks:!1,ticks:10,_thresholdPadding:4},_create:function(){this.options.width||(this.options.width=$(this.element).width()),this.options.height||(this.options.height=$(this.element).height()),this.svg=d3.select($(this.element).get(0)).append("svg"),this.background=this.svg.append("rect").attr("class","gauge-body"),this._drawBackground(),this.gradient=this.svg.append("rect").attr("class","gradient"),this.linearGradient=this.svg.append("g").append("linearGradient"),this._drawGradient(),this.axis=this.svg.append("g").attr("class","axis"),this.subAxis=this.svg.append("g").attr("class","axis").classed("minor",!0),this.thresholdsGroup=this.svg.append("g").attr("class","thresholds"),this.thresholds=this.thresholdsGroup.selectAll(".threshold").data(this.options.points);var a=this.thresholds.enter().append("g").attr("class","threshold");a.append("line"),a.append("path"),a.append("title"),this.svg.attr("width",this.options.width).attr("height",this.options.height),this.refresh()},_dispatchEvent:function(){this._trigger("change",null,{points:this.options.points,colors:this.options.colors})},refresh:function(){this._drawBackground(),this._drawGradient(),this._drawScale(),this._drawThresholds()},_drawBackground:function(){this.background.attr("x",0).attr("y",0).attr("width",this.options.width).attr("height",this.options.height).classed("gauge-body",!0)},_drawGradient:function(){var a=this;this.gradient.attr("x",this.options.margin.left).attr("y",this.options.margin.top).attr("width",this.options.width-(this.options.margin.left+this.options.margin.right)).attr("height",this.options.height-(this.options.margin.top+this.options.margin.bottom+2)).attr("fill","url(#"+$(this.element).attr("id")+"-gradient)"),this.linearGradient.attr("y1",this.options.margin.top).attr("y2",this.options.height-(this.options.margin.top+this.options.margin.bottom+2)).attr("x1",this.options.margin.left).attr("x2",this.options.width-this.options.margin.left-this.options.margin.right).attr("id",$(this.element).attr("id")+"-gradient").attr("gradientUnits","userSpaceOnUse").attr("stroke","#fcfcfc");var b=d3.scale.linear().domain([d3.min(this.options.points),d3.max(this.options.points)]).range([0,1]),c=this.linearGradient.selectAll("stop").data(this.options.points);c.enter().append("stop").attr("offset",function(a){return b(a)}).attr("stop-color",function(b,c){return a.options.colors[c]}),c.transition().duration(1e3).ease("elastic").attr("offset",function(a){return b(a)}).attr("stop-color",function(b,c){return a.options.colors[c]})},_drawThresholds:function(){if(this.options.thresholds){var a=this.thresholdsGroup.selectAll(".threshold").data(this.options.points),b=a.enter().append("g").attr("class","threshold");b.append("line"),b.append("path"),b.append("title");var c=d3.scale.linear().domain([d3.min(this.options.points),d3.max(this.options.points)]).range([0,this.options.width-(this.options.margin.left+this.options.margin.right)-1]),d=this.options.height-this.options.margin.top,e=this;a.classed("draggable",function(a){return a===d3.min(e.options.points)||a===d3.max(e.options.points)?!1:!0}).transition().duration(1e3).ease("elastic").attr("transform",function(a){return"translate("+(c(a)+1)+",2)"});var f=d3.format(",.2f"),g=null,h=d3.behavior.drag().on("dragstart",function(a){d3.select(this).attr("pointer-events","none")}).on("drag",function(a,b){g=d3.event.x,d3.select(this).attr("transform","translate("+d3.event.x+",3)");var d=d3.event.x;d3.select(this).selectAll("title").classed("tooltip",!0).text(f(c.invert(d)));var h=c(e.options.points[b+2]),i=c(e.options.points[b]);return g=d,d>h?(d3.event.sourceEvent.stopPropagation(),d=h-5,d3.select(this).transition().ease("bouncing").attr("transform","translate("+d+",3)"),d3.select(this).selectAll("title").classed("tooltip",!0).text(f(c.invert(d))),g=d,void this.dispatchEvent(new Event("mouseup"))):void(i>d&&(d3.event.sourceEvent.stopPropagation(),d=i+5,d3.select(this).transition().ease("bouncing").attr("transform","translate("+d+",3)"),d3.select(this).selectAll("title").classed("tooltip",!0).text(f(c.invert(d))),g=d,this.dispatchEvent(new Event("mouseup"))))}).on("dragend",function(a,b){var d=c.invert(g);e.options.points[b+1]=d,e.points(e.options.points),e._dispatchEvent(),d3.select(this).classed("dragging",!1),_dragCanceled=null,d3.select(this).attr("pointer-events","")});this.thresholdsGroup.selectAll(".draggable").call(h),a.select("path").attr("d",function(a){return a===d3.max(e.options.points)?"M 0 0 L 4 0 L 4 9 L 0 0":a===d3.min(e.options.points)?"M 4 0 L 9 0 L 4 9 L 4 0":"M 0 0 L 5 0 L 3 9 L 0 0"}).attr("x",0).attr("y",0),a.select("line").attr("x1",3).attr("x2",3).attr("y1",3).attr("y2",d-4),a.select("title").text(function(a){return f(a)}),a.exit().remove()}},_drawScale:function(){var a=(d3.range(20),this),b=d3.scale.linear().domain([d3.min(this.options.points),d3.max(this.options.points)]).range([0,this.options.width-(this.options.margin.left+this.options.margin.right)-1]);this.axis.attr("transform","translate("+this.options.margin.left+","+this.options.margin.top+")").call(d3.svg.axis().scale(b).orient(this.options.orient).ticks(this.options.ticks).tickSize(a.options.height-(a.options.margin.top+a.options.margin.bottom+2))),this.options.minorTicks&&this.subAxis.attr("transform","translate("+this.options.margin.left+","+this.options.margin.top+")").call(d3.svg.axis().scale(b).orient(this.options.orient).ticks(10*this.options.ticks).tickSize((a.options.height-a.options.margin.top-a.options.margin.bottom)/2))},_pointsAsValue:function(a){var b=[];return $.each(a,function(a,c){b.push(Number(c))}),b},resize:function(){this.options.width=$(this.element).width(),this.options.height=$(this.element).height(),this.refresh()},points:function(a){return void 0===a?this.options.points:(this.options.points=this._pointsAsValue(a),void this.refresh())},colors:function(a){return void 0===a?this.options.colors:(this.options.colors=a,void this.refresh())},minorTicks:function(a){return void 0===a?this.options.minorTicks:(this.options.minorTicks=a,void this.refresh())},width:function(a){return void 0===a?this.options.width:(this.options.width=a,void this.refresh())}});return a});