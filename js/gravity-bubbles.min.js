/**!
 * gravity-bubbles
 * This component, using d3js API, draw animated bubbles chart with gravity
 *
 * @license 
 * @author triad <flores.leonardo@gmail.com> (http://github.com/lflores)
 * @version 1.0.2
 **/
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.GravityBubbles=b()}):"object"==typeof exports?module.exports=b():a.GravityBubbles=b()}(this,function(){return"undefined"==typeof String.replaceParams&&(String.prototype.replaceParams=function(a){if("undefined"==typeof a)return this;"string"==typeof a&&(a=[a]);for(var b=this.replace(/^\s+|\s+$/g,""),c=0;c<a.length;c++)b=b.replace("{"+c+"}",a[c]).replace("{"+c+"}",a[c]);return b}),String.prototype.splitMultiple=function(a){"undefined"==typeof a&&(a="\n-");var b=a.split(""),c=this.split(b[0]);if(b.splice(0,1),0===b.length)return c.map(function(a){return a.trim()});for(var d=[],e=0;e<c.length;e++){var f=c[e].splitMultiple(b.join(""));f.length>1?d=d.concat(f):d.push(f[0])}return d},CustomTooltip=function(a,b){function c(b,c){var d=b.splitMultiple();$("#"+a).html(d.join("<br>")),$("#"+a).show(),e(c)}function d(){$("#"+a).hide()}function e(b){var c="#"+a,d=20,e=10,f=$(c).width(),g=$(c).height(),h=$(window).scrollTop(),i=$(window).scrollLeft(),j=document.all?b.clientX+i:b.pageX,k=document.all?b.clientY+h:b.pageY,l=j-i+2*d+f>$(window).width()?j-f-2*d:j+d;i+d>l&&(l=i+d);var m=k-h+2*e+g>$(window).height()?k-g-2*e:k+e;h+e>m&&(m=k+e),$(c).css("top",m+"px").css("left",l+"px")}return 0===$("#"+a).length&&$("body").append('<div class="gravity-tooltip" id="'+a+'"></div>'),b&&$("#"+a).css("width",b),d(),{showTooltip:c,hideTooltip:d,updatePosition:e}},GravityBubbles=function(a){this.margin={top:3,right:3,bottom:3,left:3},this.firstTime=!1;var b={sticky:!1,damper:.102,gravity:-.01,_height:600,_width:350,transition:"medium",minRadius:5,maxRadius:20,zeroBased:!1,debug:!1,lanes:4,points:[0,3,7,20,50,100],colors:["#EFF3FF","#BDD7E7","#6BAED6","#3182BD","#08519C","#08519C"],id:"gravity-bubbles",colorById:"perc",sizeById:"size",showChild:!1,groupById:"all",data:{tooltip:{template:"<b>{name}</b>",formatter:d3.format(",.2f")},label:{template:"",show:!0},group:{label:function(a,b){return"all"==b._config.groupById?"":"color"===b._config.groupById?"more"===a.key?"> "+b._config.points[b._config.points.length-1]:"<= "+a.key:a.key}},onclick:function(a,b){}},legend:{format:function(a){return d3.format(",.2f")(a)}}};this._config=$.extend(!0,b,a),this.tooltip=CustomTooltip("bubble_tooltip",240),this.create()},GravityBubbles.prototype.create=function(){this._config.container?this.container=d3.select(this._config.container):this.container=d3.select("#"+this._config.id),this.container.style("overflow","hidden"),this._config.width="undefined"==typeof this._config.width?this.container[0][0].clientWidth:this._config.width,this._config.height="undefined"==typeof this._config.height?this.container[0][0].clientHeight:this._config.height,this.svg=this.container.append("svg").attr("class","gravity-container").style("margin-top",this.margin.top).style("margin-left",this.margin.left).style("width",this._config.width-this.margin.left-this.margin.right).style("height",this._config.height-this.margin.top-this.margin.bottom),this.svg.append("g").attr("id","legend_layer"),this.svg.append("g").attr("id","groups_layer"),this.svg.append("g").attr("id","bubbles_layer"),this.svg.append("g").attr("id","groups_title_layer"),this.center={x:this._config.width/2,y:this._config.height/2},this.nodes=[],this.force=null,this.circles=null,this._data=[],this._config.groups=[],this.legend_scale=[],this.fill_color=d3.scale.linear().domain(this._config.points).range(this._config.colors),this.radius_scale=d3.scale.pow().exponent(.5).range([this._config.minRadius,this._config.maxRadius])},GravityBubbles.prototype.config=function(a){this._config=$.extend(!0,this._config,a),this._update_colors(),this.svg.style("margin-left",this.margin.left).style("margin-top",this.margin.top).style("width",this._config.width-this.margin.left-this.margin.right).style("height",this._config.height-this.margin.top-this.margin.bottom),this.force&&this.force.size([this._config.width,this._config.height]),this._update_radius(),this._data&&0!==this._data.length?this.legend_scale=[this.min_amount,this.min_amount+(this.max_amount-this.min_amount)/2,this.max_amount]:this.legend_scale=[],this.center={x:this._config.width/2,y:this._config.height/2},this.refresh()},GravityBubbles.prototype.update_details=function(a,b,c){return this.tooltip.updatePosition(c)},GravityBubbles.prototype.show_details=function(a,b,c){var d="";return"string"==typeof c._config.data.tooltip?d=c._data_replace(a,c._config.data.tooltip):"function"==typeof c._config.data.tooltip?(d=c._config.data.tooltip.call(c,a),d=c._data_replace(a,d)):"object"==typeof c._config.data.tooltip&&"string"==typeof c._config.data.tooltip.template?d=c._data_replace(a,c._config.data.tooltip.template,c._config.data.tooltip.formatter):"object"==typeof c._config.data.tooltip&&"function"==typeof c._config.data.tooltip.template&&(d=c._data_replace(a,c._config.data.tooltip.template.call(a,b,c),c._config.data.tooltip.formatter)),this.tooltip.showTooltip(d,d3.event)},GravityBubbles.prototype.hide_details=function(a,b,c){return this.tooltip.hideTooltip()},GravityBubbles.prototype._data_replace=function(a,b,c){b=b?b.slice(0):this._config.template,"undefined"==typeof c&&(c=d3.format(",.2f"));var d=b.match(/{([\w\.\_\/]+)}/g);return d&&$.each(d,function(d,e){var f=/{([\w\.\_\/]+)}/g.exec(e),g="";a.hasOwnProperty(f[1])&&"id"!=f[1]&&"name"!=f[1]&&"description"!=f[1]?g=isNaN(Number(a[f[1]]))?a[f[1]]:c(a[f[1]],f[1]):a.hasOwnProperty(f[1])&&(g=isNaN(Number(a[f[1]]))?a[f[1]]:""+Number(a[f[1]])),b=b.replace(e,g)}),b},GravityBubbles.prototype.colors=function(a){this._config.colors=a,this._update_colors(),this.refresh()},GravityBubbles.prototype.points=function(a){this._config.points=a,this._update_colors(),this._calculate_groups(),this.refresh()},GravityBubbles.prototype.colorById=function(a){this._config.colorById=a,this._update_colors(),this._calculate_groups(),this.refresh()},GravityBubbles.prototype.sizeById=function(a){var b=this;this._config.sizeById=a,this.min_amount=d3.min(this._data,function(a){return Number(a[b._config.sizeById])}),this._config.zeroBased===!0&&this.min_amount>0&&(this.min_amount=0),this.max_amount=d3.max(this._data,function(a){return Number(a[b._config.sizeById])}),this.nodes=this.nodes.sort(function(a,c){return c[b._config.sizeById]-a[b._config.sizeById]}),this._update_radius(),this.legend_scale=[this.min_amount,this.min_amount+(this.max_amount-this.min_amount)/2,this.max_amount],this.config({sizeById:a}),this.refresh()},GravityBubbles.prototype.groupById=function(a){this._config.groupById=a&&0!==a.length?a:"all";this._calculate_groups(),this.refresh()},GravityBubbles.prototype._calculate_color_group=function(a){var b=this,c=[];b._config.points.forEach(function(a,b){var d=""+a;c.push(d)}),this.group_scale=d3.scale.threshold().domain(b._config.points).range(c);var d=isNaN(Number(a[b._config.colorById]))?0:Number(a[b._config.colorById]),e=this.group_scale(d);return"undefined"==typeof e?"more":e},GravityBubbles.prototype._calculate_groups=function(){var a=this;"all"===a._config.groupById?this._config.groups=[{key:"all",values:this._data,x:this.center.x,y:this.center.y}]:this._data&&"color"===a._config.groupById?(this._color_ranges=d3.scale.threshold().domain(this._config.points).range(d3.range(this._config.points.length+1)),this._config.groups=d3.nest().key(function(b){return a._color_ranges(b[a._config.colorById])}).entries(this._data)):this._data&&this._data.length>0&&this._data[0].hasOwnProperty(this._config.groupById)&&(this._config.groups=d3.nest().key(function(b){return b[a._config.groupById]}).sortKeys(d3.ascending).entries(this._data)),this._config.groups=this._config.groups.sort(function(a,b){return b.radius-a.radius});var b="color"===this._config.groupById?this._config.groups.length:this._config.lanes,c=this._config.groups.length>b?b:this._config.groups.length,d=.9*this._config.width/c,e=this._config.height/Math.ceil(this._config.groups.length/c)-2;this._config.groups&&this._config.groups.forEach(function(a){return function(a,b){var f=Math.floor(b/c);a.x=d*(b%c),a.y=f*e,a.dx=d,a.dy=e,a.cx=a.x+a.dx/2,a.cy=a.y+a.dy/2}}(this))},GravityBubbles.prototype._calculate_boundary=function(a){var b=0;return a.forEach(function(a){return function(c){var d=a._radius_by(c),e=Math.PI*Math.pow(d,2);b+=e}}(this)),Math.sqrt(b/Math.PI)},GravityBubbles.prototype.data=function(a){this._data=a;var b=this;return this._data&&0!==this._data.length?(this.svg.selectAll(".selected").classed("selected",!1),this.min_amount=d3.min(this._data,function(a){return Number(a[b._config.sizeById])}),this.max_amount=d3.max(this._data,function(a){return Number(a[b._config.sizeById])}),this.legend_scale=[this.min_amount,this.min_amount+(this.max_amount-this.min_amount)/2,this.max_amount],this.create_nodes(),this._calculate_groups(),this.min_amount==this.max_amount&&(this.min_amount-=1,this.max_amount+=1),this._config.zeroBased===!0&&this.min_amount>0&&(this.min_amount=0),this.radius_scale.domain([this.min_amount,this.max_amount]).range([this._config.minRadius,this._config.maxRadius]),this.force=d3.layout.force().nodes(this.nodes).size([this._config.width/2,this._config.height/2]),this.force.gravity(function(a){return function(b){return a._config.gravity}}(this)).charge(function(a){return function(b,c){var d=(b[a._config.groupById]?b[a._config.groupById]:"all",a._radius_by(b));return-Math.pow(d,2)/8}}(this)).friction(.9).on("tick",function(a){return function(b){return a.labels&&a.labels.each(function(){d3.select(this).call(a._label_position,a)}),a.circles.each(a.move_towards_center(b.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}}(this)).on("end",function(a){return function(b){a._config.data.label&&a.labels.call(a._label_position,a)}}(this)),void this.refresh()):(this._data=[],this.nodes=[],this.legend_scale=[],void this.refresh())},GravityBubbles.prototype.move_towards_center=function(a){return function(b){return function(c){var d=b._get_target(c,b);return d?(c.x=c.x+(d.cx-c.x)*b._config.damper*a*1.1,c.y=c.y+(d.cy-c.y)*b._config.damper*a*1.1,c.y):0}}(this)},GravityBubbles.prototype._get_group=function(a){var b={};return this._config.groups.forEach(function(c){var d=""+c.key,e=""+a;d===e&&(b=c)}),b},GravityBubbles.prototype.create_nodes=function(){var a=this;return this.nodes=[],this._data.forEach(function(a){return function(b){return a.nodes.push(b)}}(this)),this.nodes.sort(function(b,c){return c[a._config.sizeById]-b[a._config.sizeById]})},GravityBubbles.prototype._keep_position=function(a,b){a.each(function(a){"undefined"==typeof a.x&&(a.x=Number(d3.select(this).attr("cx")),a.y=Number(d3.select(this).attr("cy")))})},GravityBubbles.prototype._draw_groups=function(){var a=this.svg.selectAll("#groups_layer"),b=a.selectAll(".group").data(this._config.groups);b.enter().append("rect").attr("class","group").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.dx>0?a.dx:1}).attr("height",function(a){return a.dy>0?a.dy:1}),b.classed("multiple",function(a){return"all"!=a.key}).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.dx>0?a.dx:1}).attr("height",function(a){return a.dy>0?a.dy:1}),b.exit().remove();var c=this.svg.selectAll("#groups_title_layer"),d=c.selectAll(".group-text").data(this._config.groups);d.enter().append("text").attr("class","group-text").call(this._draw_group_text,this).call(this._draw_group_position,this),d.call(this._draw_group_text,this).call(this._draw_group_position,this),d.exit().remove()},GravityBubbles.prototype._draw_group_text=function(a,b){a.text(""),"all"!==b._config.groupById&&a.each(function(a){if("color"===b._config.groupById){var c=b._color_ranges.invertExtent(parseInt(a.key)),d=["<"];c[0]&&d.splice(0,0,Math.round(c[0]).toString()),c[1]&&d.push(Math.round(c[1])),_tspans=[d.join(" ")]}else if(b._config.data.group&&b._config.data.group.label&&"function"==typeof b._config.data.group.label){var e=b._config.data.group.label.call(b,a,b);_tspans=e.splitMultiple().reverse()}var f=_tspans.pop(),g=0;do{var h=d3.select(this).append("tspan");h.attr("dy",".8em").text(f),g++,f=_tspans.pop()}while(f);var i=(this.getBBox().width,Array.prototype.slice.call(this.childNodes,0));i.forEach(function(b){var c=b.getComputedTextLength();d3.select(b).attr("x",a.cx-c/2)})})},GravityBubbles.prototype._draw_group_position=function(a,b){a.each(function(a){d3.select(this).attr("y",a.y+2);var b=Array.prototype.slice.call(this.childNodes,0);b.forEach(function(b){var c=b.getComputedTextLength();d3.select(b).attr("x",a.cx-c/2)})})},GravityBubbles.prototype._label_text=function(a,b){if(b._config.data&&b._config.data.label&&b._config.data.label.template&&"string"==typeof b._config.data.label.template)return b._data_replace(a,b._config.data.label.template,b._config.data.label.formatter);if(b._config.data&&b._config.data.label&&b._config.data.label.template&&"function"==typeof b._config.data.label.template){var c=b._config.data.label.template.call(b,[a]);return b._data_replace(a,c,b._config.data.label.formatter)}return null},GravityBubbles.prototype._draw_text=function(a,b){a.text(null),a.each(function(a){var c=b._label_text(a,b);if(c){var d=d3.select(this),e=c.splitMultiple().reverse(),f=e.pop(),g=0,h=(d.attr("x"),d.attr("y"));a.dy-4,d.data(0);do tspan=d.append("tspan").attr("x",0).attr("y",h).attr("dy","1em").classed("head",function(a){return 0===g}).text(f),g++,f=e.pop();while(f);var i=this.getBBox().width,j=Array.prototype.slice.call(this.childNodes,0);j.forEach(function(a){var b=a.getComputedTextLength(),c=i-b;d3.select(a).attr("x",c>0?c/2:0)})}}).call(b._label_position,b)},GravityBubbles.prototype._label_position=function(a,b){a.attr("transform",function(a){return function(b){var c=this.getBBox();if(!b.x||!b.y)return"translate(0,0)";var d=d3.select(this.parentNode).selectAll("circle").attr("cx"),e=d3.select(this.parentNode).selectAll("circle").attr("cy");if(a._config.data.label&&a._config.data.label.hasOwnProperty("autofit")&&a._config.data.label.autofit){var f=a._radius_by(b),g=Math.sqrt(Math.pow(c.width,2)+Math.pow(c.height,2)),h=Number(f/(g/2)),i=(Number(g/2/f),0===g?d:d-c.width/2*h),j=0===g?e:e-c.height/2*h;h=0===g?1:h;var k="translate({0},{1}),scale({2},{2})";return k.replaceParams([i,j,h])}return"translate("+(d-c.width/2)+","+(e-c.height/2)+")"}}(b)).attr("visibility",function(a){return function(b){var c=this.getBBox(),d=a._radius_by(b);return c.width>0&&c.height>0&&c.width<=1.8*d&&("undefined"==typeof a._config.data.label.show||a._config.data.label.show)?"visible":a._config.data.label&&a._config.data.label.hasOwnProperty("autofit")&&a._config.data.label.autofit?"visible":"hidden"}}(b))},GravityBubbles.prototype._update_radius=function(){var a="color"===this._config.groupById?this._config.groups.length:this._config.lanes,b=this._config.groups.length>a?a:this._config.groups.length,c=.9*this._config.width/b;if("all"===this._config.groupById){var d=this._data.length>0?this._calculate_boundary(this._data):.1,e=d>0?this._config.height/2*this._config.maxRadius/d:.1;this._config.maxRadius=.9*e}else this._config.maxRadius=.1*c;this._config.maxRadius=this._config.maxRadius<this._config.minRadius?this._config.minRadius+1:this._config.maxRadius,this._config.zeroBased===!0&&this.min_amount>0&&(this.min_amount=0),this.radius_scale.range([this._config.minRadius,this._config.maxRadius]),this.radius_scale.domain([this.min_amount,this.max_amount]).range([this._config.minRadius,this._config.maxRadius])},GravityBubbles.prototype.refresh=function(){this._config.width="undefined"==typeof this._config.width?this.container[0][0].clientWidth:this._config.width,this._config.height="undefined"==typeof this._config.height?this.container[0][0].clientHeight:this._config.height,this._draw_groups(),this._update_radius(),this._draw_circles(),this._draw_centers(),this._draw_legends(),this.force&&this.force.start()},GravityBubbles.prototype._draw_centers=function(){if(this._config.debug){var a=this.svg.selectAll(".centers").data(this._config.groups);a.enter().append("circle").attr("class","centers").attr("r",function(a){return 5}).attr("fill","#000").attr("cx",function(a){return a.cx}).attr("cy",function(a){return a.cy}),a.attr("cx",function(a){return a.cx}).attr("cy",function(a){return a.cy}),a.exit().remove()}},GravityBubbles.prototype._center=function(){this.center.x=.75*this._config.width/2,this.center.y=this._config.height/2},GravityBubbles.prototype._draw_legends=function(){var a=this.svg.selectAll("#legend_layer");this.legends=a.selectAll(".legend-circle").data(this.legend_scale),this.legends.enter().append("circle").attr("class","legend-circle").attr("r",function(a){return function(b){return a.legend_scale&&0!==a.legend_scale.length?a.radius_scale(b):0}}(this)).attr("cx",function(a){return function(b){return a.legend_scale&&0!==a.legend_scale.length?a._config.width-a.radius_scale(a.legend_scale[2])-a.margin.right-a.margin.left:0}}(this)).attr("cy",function(a){return function(b){return a.legend_scale&&0!==a.legend_scale.length?a._config.height-a.radius_scale(b)-a.margin.bottom-a.margin.top:0}}(this)),this.legends.transition().duration(this._get_transition()).attr("r",function(a){return function(b){return a.legend_scale&&0!==a.legend_scale.length?a.radius_scale(b):0}}(this)).attr("cx",function(a){return function(b){return a.legend_scale&&0!==a.legend_scale.length?a._config.width-a.radius_scale(a.legend_scale[2])-a.margin.right-a.margin.left:0}}(this)).attr("cy",function(a){return function(b){return a.legend_scale&&0!==a.legend_scale.length?a._config.height-a.radius_scale(b)-a.margin.bottom-a.margin.top:0}}(this)),this.legends.exit().remove(),this.legends_texts=a.selectAll(".legend-text").data(this.legend_scale),this.legends_texts.enter().append("text").attr("class","legend-text").call(this._legend_text,this).call(this._legend_text_position,this),this.legends_texts.call(this._legend_text,this).call(this._legend_text_position,this),this.legends_texts.exit().remove()},GravityBubbles.prototype._legend_text=function(a,b){this.text(function(a){return b._config.legend&&b._config.legend.format?b._config.legend.format.call(this,a):void 0})},GravityBubbles.prototype._legend_text_position=function(a,b){this.transition().attr("x",function(a){var c=this.getComputedTextLength();return b._config.width-b.radius_scale(b.legend_scale[2])-c/2-b.margin.right}).attr("y",function(a){return b._config.height-(2*b.radius_scale(a)+b.margin.bottom+5)})},GravityBubbles.prototype._draw_circles=function(){var a=this.svg.select("#bubbles_layer");this.bubbles=a.selectAll("g").data(this.nodes);var b=this;this.bubbles.enter().append("g").on("mouseover",function(a,c){return b.show_details(a,c,b)}).on("mouseout",function(a,c){return b.hide_details(a,c,b)}).on("click",function(a,c){b.hide_details(a,c,b),d3.select(this).classed("selected",function(a,b){return!d3.select(this).classed("selected")}),b._config.data.onclick.call(b,a,this,c)}).append("circle").attr("class","bubble").attr("stroke",function(a){return d3.rgb(b._fill_color_by(a)).darker()}).attr("stroke-width",1).attr("fill",function(a){return b._fill_color_by(a)}).attr("r",function(a){return 0}).attr("cx",function(a){var c=b._get_target(a,b);return c?(a.x=Math.floor(Math.random()*(c.dx-c.x+1))+c.x,a.x):0}).attr("cy",function(a){var c=b._get_target(a,b);return c?(a.y=Math.floor(Math.random()*(c.dy-c.y+1))+c.y,a.y):0}).on("mouseover",function(a,b){}).on("mouseout",function(a,b){}).on("click",function(a,b){}).select(function(){return this.parentNode}).append("text").attr("class","label").call(b._draw_text,this),this.circles=a.selectAll(".bubble").data(this.nodes),this.circles.transition().duration(this._get_transition()).ease("ease-in-out").attr("r",function(a){return b._radius_by(a)}).attr("stroke",function(a){return d3.rgb(b._fill_color_by(a)).darker()}).attr("fill",function(a){return b._fill_color_by(a)}).call(b._keep_position,b).text(function(a){return a.weight}),this.circles.exit().remove(),this.labels=a.selectAll(".label").data(this.nodes),this.labels.call(b._draw_text,b),this.labels.exit().remove(),this.bubbles.exit().remove()},GravityBubbles.prototype._get_transition=function(){var a=500;switch(this._config.transition){case"slow":a=1e3;break;case"quick":a=100;break;default:a=500}return a},GravityBubbles.prototype._get_target=function(a,b){var c="undefined"==typeof b._config.groupById||"all"===b._config.groupById?"all":b._config.groupById;switch(c){case"all":target=b._get_group("all");break;case"color":target=b._get_group(b._color_ranges(a[b._config.colorById]));break;default:target=b._get_group(a[b._config.groupById])}return target},GravityBubbles.prototype._calculate_circle_position=function(a,b){a.attr("cx",function(a){return d3.select(this).attr("cx")?d3.select(this).attr("cx"):a.x}).attr("cy",function(a){return d3.select(this).attr("cy")?d3.select(this).attr("cy"):a.y})},GravityBubbles.prototype._update_colors=function(){this.fill_color=d3.scale.linear().domain(this._config.points).range(this._config.colors),this.color_layer=d3.scale.linear().domain(this._config.points).range([0,this._config.height/4,this._config.height/2,this._config.height/4+this._config.height/2,this._config.height]),this.nodes.forEach(function(a){return function(b){b.weight=a.color_layer(Number(b[a._config.colorById]))}}(this)),this.force},GravityBubbles.prototype._fill_color_by=function(a){return a.hasOwnProperty(this._config.colorById)&&!isNaN(a[this._config.colorById])?this.fill_color(a[this._config.colorById]):0},GravityBubbles.prototype._radius_by=function(a){if(a.hasOwnProperty(this._config.sizeById)&&!isNaN(a[this._config.sizeById])){var b=this.radius_scale(a[this._config.sizeById]);return b}return 0},GravityBubbles.prototype.resize=function(){this.config({width:parseInt(this.container.style("width")),height:parseInt(this.container.style("height"))});this._data&&this._data.length>0&&(this._calculate_groups(),this.refresh())},GravityBubbles});